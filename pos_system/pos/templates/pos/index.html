{% load static %}
{% load dict_extras %}
<!DOCTYPE html>
<html>
<head>
    <title>Sistema de PDV</title>
    <link rel="stylesheet" href="{% static 'pos/style.css' %}">
    <meta name="csrf-token" content="{% csrf_token %}">
</head>
<body>
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <h1 style="color:#ff9800; margin: 0;">La casa de Pastel</h1>
        <div>
            <a href="{% url 'dashboard' %}" class="header-btn">Dashboard</a>
            <a href="{% url 'logout' %}" class="header-btn">Sair</a>
        </div>
    </header>
    <div id="table-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; justify-content:center; margin-top: 20px;">
        <!-- Tabs will be generated by JS -->
    </div>
    <div style="text-align: center; margin-bottom: 20px;">
        <button id="view-history-btn" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Ver Histórico de Pedidos da Mesa</button>
    </div>
    <div class="container">
        <div class="products">
            <h2 style="color:#333;margin-bottom:16px;">Produtos</h2>
            {% for key, label in categories %}
                <h3 {% if key == 'acompanhamento' %}id="acompanhamento-category-title" style="display: none;"{% endif %}>{{ label }}</h3>
                <div class="product-grid" {% if key == 'acompanhamento' %}id="acompanhamento-category" style="display: none;"{% endif %}>
                    {% for product in products_by_category|get_item:key %}
                        <button class="product-btn" onclick="addToCart('{{ product.id }}', '{{ product.name }}', '{{ product.price }}', '{{ product.category }}')">
                            <span class="product-name">{{ product.name }}</span>
                            <span class="product-price">R$ {{ product.price }}</span>
                        </button>
                    {% empty %}
                        <span><em>Nenhum produto nesta categoria.</em></span>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        <div class="cart">
            <h2>Carrinho - Mesa <span id="current-table-num"></span></h2>
            <ul class="cart-list" id="cart-list"></ul>
            <div class="subtotal" id="subtotal">Subtotal: R$ 0,00</div>
            <button id="confirm-accompaniments-btn" style="width:100%;margin-top:8px; display: none;">Confirmar Acompanhamentos</button>
            <button id="kitchen-btn" style="width:100%;margin-top:20px;">Imprimir Cozinha</button>
            <button id="client-btn" style="width:100%;margin-top:8px;">Imprimir Cliente</button>
        </div>
    </div>

    <!-- Accompaniments Popup -->
    <div id="accompaniments-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-width: 600px; width: 90%;">
            <h3 style="color:#333;margin-bottom:16px;">Acompanhamentos</h3>
            <div class="product-grid">
                {% for product in products_by_category|get_item:'acompanhamento' %}
                    <button class="product-btn" onclick="addToCart('{{ product.id }}', '{{ product.name }}', '{{ product.price }}', '{{ product.category }}')">
                        <span class="product-name">{{ product.name }}</span>
                        <span class="product-price">R$ {{ product.price }}</span>
                    </button>
                {% empty %}
                    <span><em>Nenhum acompanhamento disponível.</em></span>
                {% endfor %}
            </div>
            <button id="close-accompaniments-popup-btn" style="width:100%;margin-top:20px; padding: 10px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Fechar Acompanhamentos</button>
        </div>
        
    </div>

    <!-- Order History Popup -->
    <div id="order-history-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
            <h3 style="color:#333;margin-bottom:16px;">Histórico de Pedidos - Mesa <span id="history-table-num"></span></h3>
            <div id="order-history-content">
                <!-- Order history will be loaded here -->
                <p>Carregando histórico...</p>
            </div>
            <button id="close-history-popup-btn" style="width:100%;margin-top:20px; padding: 10px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Fechar Histórico</button>
        </div>
    </div>

    <!-- Payment Method Popup -->
    <div id="payment-method-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1002; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-width: 400px; width: 90%;">
            <h3 style="color:#333;margin-bottom:16px;">Selecione o Método de Pagamento</h3>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="payment-btn" data-method="Dinheiro" style="padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Dinheiro</button>
                <button class="payment-btn" data-method="Cartao" style="padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Cartão</button>
                <button class="payment-btn" data-method="Pix" style="padding: 10px; background-color: #FFC107; color: #333; border: none; border-radius: 4px; cursor: pointer;">Pix</button>
            </div>
            <button id="cancel-payment-popup-btn" style="width:100%;margin-top:20px; padding: 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
        </div>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        let carts = {}; // Stores cart items for each table
        let currentTable = 1; // Default to table 1
        let activeMainProduct = null; // To track the main product for accompaniment selection

        // Initialize carts for 5 tables
        for (let i = 1; i <= 5; i++) {
            carts[i] = {};
        }

        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            return `${year}${month}${day}-${hours}${minutes}${seconds}`;
        }

        function renderTabs() {
            const tableTabsDiv = document.getElementById('table-tabs');
            tableTabsDiv.innerHTML = ''; // Clear existing tabs
            for (let i = 1; i <= 5; i++) {
                const button = document.createElement('button');
                button.textContent = `Mesa ${i}`;
                button.className = 'tab-button';
                if (i === currentTable) {
                    button.classList.add('active');
                }
                button.onclick = () => switchTable(i);
                tableTabsDiv.appendChild(button);
            }
            document.getElementById('current-table-num').textContent = currentTable;
        }

        function switchTable(tableNum) {
            currentTable = tableNum;
            renderTabs();
            renderCart();
            clearActiveMainProduct(); // Clear active product when switching tables
            hideAccompanimentsSection(); // Hide accompaniments if open
            hideOrderHistoryPopup(); // Hide history if open
            hidePaymentMethodPopup(); // Hide payment if open
        }

        function addToCart(productId, productName, productPrice, productCategory) {
            const price = parseFloat(productPrice);

            if (productCategory === 'tradicional' || productCategory === 'especial' || productCategory === 'doce') {
                // If a main product is selected, set it as active and show accompaniments
                activeMainProduct = { id: productId, name: productName, price: price, category: productCategory, quantity: 1, accompaniments: {} };
                showAccompanimentsSection();
            } else if (productCategory === 'acompanhamento') {
                if (activeMainProduct) {
                    // Add accompaniment to the active main product
                    if (activeMainProduct.accompaniments[productId]) {
                        activeMainProduct.accompaniments[productId].quantity++;
                    } else {
                        activeMainProduct.accompaniments[productId] = { id: productId, name: productName, price: price, category: productCategory, quantity: 1 };
                    }
                    renderCart(); // Re-render to show updated accompaniments
                } else {
                    // If no main product is active, add accompaniment directly to cart (as a standalone item)
                    if (carts[currentTable][productId]) {
                        carts[currentTable][productId].quantity++;
                    } else {
                        carts[currentTable][productId] = { id: productId, name: productName, price: price, category: productCategory, quantity: 1 };
                    }
                    renderCart();
                }
            } else { // For 'bebida' or other categories, add directly to cart
                if (carts[currentTable][productId]) {
                    carts[currentTable][productId].quantity++;
                } else {
                    carts[currentTable][productId] = { id: productId, name: productName, price: price, category: productCategory, quantity: 1 };
                }
                renderCart();
            }
        }

        function removeFromCart(productId, isAccompaniment = false, mainProductId = null) {
            if (isAccompaniment && mainProductId && carts[currentTable][mainProductId] && carts[currentTable][mainProductId].accompaniments[productId]) {
                if (carts[currentTable][mainProductId].accompaniments[productId].quantity > 1) {
                    carts[currentTable][mainProductId].accompaniments[productId].quantity--;
                } else {
                    delete carts[currentTable][mainProductId].accompaniments[productId];
                }
            } else if (carts[currentTable][productId]) {
                if (carts[currentTable][productId].quantity > 1) {
                    carts[currentTable][productId].quantity--;
                } else {
                    delete carts[currentTable][productId];
                }
            }
            renderCart();
        }

        function clearActiveMainProduct() {
            if (activeMainProduct) {
                // Add the active main product and its accompaniments to the cart
                if (carts[currentTable][activeMainProduct.id]) {
                    // If product already exists, just update quantity and merge accompaniments
                    carts[currentTable][activeMainProduct.id].quantity += activeMainProduct.quantity;
                    for (const accId in activeMainProduct.accompaniments) {
                        if (carts[currentTable][activeMainProduct.id].accompaniments[accId]) {
                            carts[currentTable][activeMainProduct.id].accompaniments[accId].quantity += activeMainProduct.accompaniments[accId].quantity;
                        } else {
                            carts[currentTable][activeMainProduct.id].accompaniments[accId] = activeMainProduct.accompaniments[accId];
                        }
                    }
                } else {
                    carts[currentTable][activeMainProduct.id] = activeMainProduct;
                }
                activeMainProduct = null;
            }
            hideAccompanimentsSection(); // Always hide after confirming or cancelling
            renderCart();
        }

        function renderCart() {
            const cartList = document.getElementById('cart-list');
            const subtotalElement = document.getElementById('subtotal');
            cartList.innerHTML = '';
            let subtotal = 0;

            // Display active main product and its accompaniments separately if it exists
            if (activeMainProduct) {
                const mainItemLi = document.createElement('li');
                mainItemLi.className = 'cart-item active-main-product';
                mainItemLi.innerHTML = `
                    <span>${activeMainProduct.quantity}x ${activeMainProduct.name}</span>
                    <span>R$ ${(activeMainProduct.quantity * activeMainProduct.price).toFixed(2)}</span>
                `;
                cartList.appendChild(mainItemLi);
                subtotal += activeMainProduct.quantity * activeMainProduct.price;

                for (const accId in activeMainProduct.accompaniments) {
                    const acc = activeMainProduct.accompaniments[accId];
                    const accLi = document.createElement('li');
                    accLi.className = 'cart-item accompaniment-item';
                    accLi.innerHTML = `
                        <span style="margin-left: 20px;">+ ${acc.quantity}x ${acc.name}</span>
                        <span>R$ ${(acc.quantity * acc.price).toFixed(2)}</span>
                        <button onclick="removeFromCart('${acc.id}', true, '${activeMainProduct.id}')" style="background-color: #f44336; color: white; border: none; border-index: 4px; cursor: pointer; margin-left: 8px;">-</button>
                    `;
                    cartList.appendChild(accLi);
                    subtotal += acc.quantity * acc.price;
                }
            }

            // Display items already in the cart
            for (const productId in carts[currentTable]) {
                const item = carts[currentTable][productId];
                const listItem = document.createElement('li');
                listItem.className = 'cart-item';
                listItem.innerHTML = `
                    <span>${item.quantity}x ${item.name}</span>
                    <span>R$ ${(item.quantity * item.price).toFixed(2)}</span>
                    <button onclick="removeFromCart('${productId}')" style="background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 8px;">-</button>
                `;
                cartList.appendChild(listItem);
                subtotal += item.quantity * item.price;

                if (item.accompaniments) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        const accLi = document.createElement('li');
                        accLi.className = 'cart-item accompaniment-item';
                        accLi.innerHTML = `
                            <span style="margin-left: 20px;">+ ${acc.quantity}x ${acc.name}</span>
                            <span>R$ ${(acc.quantity * acc.price).toFixed(2)}</span>
                            <button onclick="removeFromCart('${acc.id}', true, '${productId}')" style="background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 8px;">-</button>
                        `;
                        cartList.appendChild(accLi);
                        subtotal += acc.quantity * acc.price;
                    }
                }
            }
            subtotalElement.textContent = `Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}`;
        }

        function showAccompanimentsSection() {
            console.log('showAccompanimentsSection called: Displaying popup.'); // Debugging line
            document.getElementById('accompaniments-popup').style.display = 'flex'; // Show the popup
        }

        function hideAccompanimentsSection() {
            const popup = document.getElementById('accompaniments-popup');
            if (popup) {
                // Ensure display is set to 'none' with !important to override any conflicting styles
                popup.style.setProperty('display', 'none', 'important');
                console.log('hideAccompanimentsSection called: Popup display set to none !important.'); // Debugging line
            } else {
                console.error('Error: Accompaniments popup element not found when trying to hide.'); // Debugging line
            }
        }

        // --- Order History Popup Logic ---
        function showOrderHistoryPopup() {
            document.getElementById('history-table-num').textContent = currentTable;
            document.getElementById('order-history-popup').style.display = 'flex';
            fetchAndDisplayOrderHistory(currentTable);
        }

        function hideOrderHistoryPopup() {
            document.getElementById('order-history-popup').style.display = 'none';
        }

        async function fetchAndDisplayOrderHistory(tableNumber) {
            const historyContent = document.getElementById('order-history-content');
            historyContent.innerHTML = '<p>Carregando histórico...</p>'; // Show loading message

            try {
                const response = await fetch(`/get_order_history/${tableNumber}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Order history fetched:', data);

                if (data.orders && data.orders.length > 0) {
                    let html = '';
                    data.orders.forEach(order => {
                        html += `<div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px;">`;
                        html += `<p><strong>Pedido ID:</strong> ${order.id}</p>`;
                        html += `<p><strong>Data:</strong> ${new Date(order.timestamp).toLocaleString()}</p>`;
                        html += `<p><strong>Total:</strong> R$ ${parseFloat(order.total_price).toFixed(2).replace('.', ',')}</p>`;
                        html += `<p><strong>Itens:</strong></p><ul>`;
                        order.items.forEach(item => {
                            html += `<li>${item.name} - R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')} x ${item.quantity}`;
                            if (item.accompaniments && item.accompaniments.length > 0) {
                                html += `<ul>`;
                                item.accompaniments.forEach(acc => {
                                    html += `<li style="font-size: 0.9em; color: #555;">+ ${acc.name} - R$ ${parseFloat(acc.price).toFixed(2).replace('.', ',')} x ${acc.quantity}</li>`;
                                });
                                html += `</ul>`;
                            }
                            html += `</li>`;
                        });
                        html += `</ul></div>`;
                    });
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<p>Nenhum pedido anterior encontrado para esta mesa.</p>';
                }

            } catch (error) {
                console.error('Error fetching order history:', error);
                historyContent.innerHTML = '<p>Erro ao carregar o histórico de pedidos.</p>';
            }
        }

        // --- Payment Method Popup Logic ---
        function showPaymentMethodPopup() {
            document.getElementById('payment-method-popup').style.display = 'flex';
        }

        function hidePaymentMethodPopup() {
            document.getElementById('payment-method-popup').style.display = 'none';
        }

        async function saveOrderToDatabase(cart, tableNumber) {
            try {
                const response = await fetch('/save_order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        table_number: tableNumber,
                        cart_items: cart
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('Order saved successfully:', data);
                    return data.order_id;
                } else {
                    console.error('Error saving order:', data.message);
                    alert('Erro ao salvar o pedido: ' + data.message);
                    return null;
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                alert('Erro de comunicação com o servidor ao salvar o pedido.');
                return null;
            }
        }

        // Helper function to format for thermal printer (client ticket)
        function formatForThermalPrinter(cart, orderNumber, paymentMethod) {
            let receipt = `--- Pedido Cliente ---\n`;
            receipt += `Mesa: ${currentTable}\n`;
            receipt += `Pedido Nº: ${orderNumber}\n`;
            receipt += `Data: ${new Date().toLocaleString()}\n`;
            receipt += `----------------------\n`;
            let subtotal = 0;
            for (const productId in cart) {
                const item = cart[productId];
                receipt += `${item.quantity}x ${item.name} - R$ ${item.price.toFixed(2)}\n`;
                subtotal += item.quantity * item.price;
                if (item.accompaniments) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        receipt += `  + ${acc.quantity}x ${acc.name} - R$ ${acc.price.toFixed(2)}\n`;
                        subtotal += acc.quantity * acc.price;
                    }
                }
            }
            receipt += `----------------------\n`;
            receipt += `Total: R$ ${subtotal.toFixed(2)}\n`;
            receipt += `Método de Pagamento: ${paymentMethod}\n`; // Add payment method
            receipt += `----------------------\n`;
            receipt += `Obrigado!\n`;
            return receipt;
        }

        // Helper function to format for kitchen ticket
        function formatForKitchen(cart, orderNumber) {
            let receipt = `--- Pedido Cozinha ---\n`;
            receipt += `Mesa: ${currentTable}\n`;
            receipt += `Pedido Nº: ${orderNumber}\n`;
            receipt += `Data: ${new Date().toLocaleString()}\n`;
            receipt += `----------------------\n`;
            for (const productId in cart) {
                const item = cart[productId];
                receipt += `${item.quantity}x ${item.name}\n`;
                if (item.accompaniments) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        receipt += `  + ${acc.quantity}x ${acc.name}\n`;
                    }
                }
            }
            receipt += `----------------------\n`;
            return receipt;
        }

        async function printKitchenTicketOnly() {
            let cart = carts[currentTable];
            if (Object.keys(cart).length === 0) {
                alert("O carrinho está vazio!");
                return;
            }

            const orderNumber = generateOrderNumber(); // Generate a temporary order number for printing

            // Print Kitchen Ticket
            const kitchenTxt = formatForKitchen(cart, orderNumber).replace(/\n/g, '<br>');
            const kitchenPrintWindow = window.open('', '_blank', 'width=400,height=600');
            kitchenPrintWindow.document.write(`
                <html>
                <head>
                    <title>Pedido Cozinha ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${kitchenTxt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            kitchenPrintWindow.document.close();
            kitchenPrintWindow.focus();
            // Do NOT clear cart or save to DB here
        }

        async function processOrderAndPrintAll(paymentMethod) {
            hidePaymentMethodPopup(); // Hide the payment popup immediately

            let cart = carts[currentTable];
            if (Object.keys(cart).length === 0) {
                alert("O carrinho está vazio!");
                return;
            }

            const orderId = await saveOrderToDatabase(cart, currentTable);
            if (orderId === null) {
                return; // Stop if saving failed
            }

            const orderNumber = generateOrderNumber();

            // Print Client Ticket
            const clientTxt = formatForThermalPrinter(cart, orderNumber, paymentMethod).replace(/\n/g, '<br>'); // Pass paymentMethod
            const clientPrintWindow = window.open('', '_blank', 'width=400,height=600');
            clientPrintWindow.document.write(`
                <html>
                <head>
                    <title>Pedido Cliente ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${clientTxt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            clientPrintWindow.document.close();
            clientPrintWindow.focus();

            // Print Kitchen Ticket (again, if not already printed, or as a final confirmation)
            const kitchenTxt = formatForKitchen(cart, orderNumber).replace(/\n/g, '<br>');
            const kitchenPrintWindow = window.open('', '_blank', 'width=400,height=600');
            kitchenPrintWindow.document.write(`
                <html>
                <head>
                    <title>Pedido Cozinha ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${kitchenTxt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            kitchenPrintWindow.document.close();
            kitchenPrintWindow.focus();

            // Clear cart for the current table after successful printing and saving
            carts[currentTable] = {};
            renderCart();
            clearActiveMainProduct();
        }


        document.getElementById('kitchen-btn').onclick = async function() {
            printKitchenTicketOnly();
        };

        document.getElementById('client-btn').onclick = async function() {
            let cart = carts[currentTable];
            if (Object.keys(cart).length === 0) {
                alert("O carrinho está vazio!");
                return;
            }
            showPaymentMethodPopup();
        };

        document.getElementById('confirm-accompaniments-btn').onclick = function() {
            clearActiveMainProduct();
            renderCart(); // Re-render to ensure display is correct
        };

        document.getElementById('close-accompaniments-popup-btn').onclick = function() {
            console.log('Close accompaniments popup button clicked.'); // Debugging line
            clearActiveMainProduct(); 
            renderCart(); // Re-render to ensure display is correct
        };

        document.getElementById('view-history-btn').onclick = function() {
            showOrderHistoryPopup();
        };

        document.getElementById('close-history-popup-btn').onclick = function() {
            hideOrderHistoryPopup();
        };

        // Event listeners for payment method buttons
        document.querySelectorAll('.payment-btn').forEach(button => {
            button.onclick = function() {
                const paymentMethod = this.getAttribute('data-method');
                processOrderAndPrintAll(paymentMethod); // Call the new function
            };
        });

        document.getElementById('cancel-payment-popup-btn').onclick = function() {
            hidePaymentMethodPopup();
        };

        // Initial render
        renderTabs();
        renderCart();
    </script>
</body>
</html>