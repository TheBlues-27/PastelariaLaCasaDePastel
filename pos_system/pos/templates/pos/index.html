{% load static %}
{% load dict_extras %}
<!DOCTYPE html>
<html>
<head>
    <title>Sistema de PDV</title>
    <link rel="stylesheet" href="{% static 'pos/style.css' %}">
    <meta name="csrf-token" content="{% csrf_token %}">
</head>
<body>
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <h1 style="color:#ff9800; margin: 0;">La casa de Pastel</h1>
        <div>
            <a href="{% url 'dashboard' %}" class="header-btn">Dashboard</a>
            <a href="{% url 'logout' %}" class="header-btn">Sair</a>
        </div>
    </header>
    <div id="table-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; justify-content:center; margin-top: 20px;">
        <!-- Tabs will be generated by JS -->
    </div>
    <div class="container">
        <div class="products">
            <h2 style="color:#333;margin-bottom:16px;">Produtos</h2>
            {% for key, label in categories %}
                <h3 {% if key == 'acompanhamento' %}id="acompanhamento-category-title" style="display: none;"{% endif %}>{{ label }}</h3>
                <div class="product-grid" {% if key == 'acompanhamento' %}id="acompanhamento-category" style="display: none;"{% endif %}>
                    {% for product in products_by_category|get_item:key %}
                        <button class="product-btn" onclick="addToCart('{{ product.id }}', '{{ product.name }}', '{{ product.price }}', '{{ product.category }}')">
                            <span class="product-name">{{ product.name }}</span>
                            <span class="product-price">R$ {{ product.price }}</span>
                        </button>
                    {% empty %}
                        <span><em>Nenhum produto nesta categoria.</em></span>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        <div class="cart">
            <h2>Carrinho - Mesa <span id="current-table-num"></span></h2>
            <ul class="cart-list" id="cart-list"></ul>
            <div class="subtotal" id="subtotal">Subtotal: R$ 0,00</div>
            <button id="confirm-accompaniments-btn" style="width:100%;margin-top:8px; display: none;">Confirmar Acompanhamentos</button>
            <button id="checkout-btn" style="width:100%;margin-top:20px;">Imprimir Cliente</button>
            <button id="kitchen-btn" style="width:100%;margin-top:8px;">Imprimir Cozinha</button>
        </div>
    </div>
    <script>
        // --- TABLE TAB LOGIC ---
        const NUM_TABLES = 10; // Change this for more tables
        let currentTable = 1;
        let carts = {};
        for (let i = 1; i <= NUM_TABLES; i++) {
            carts[i] = {};
        }

        // Global state for accompaniment selection
        let activeMainProductId = null;

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        function renderTabs() {
            const tabDiv = document.getElementById('table-tabs');
            tabDiv.innerHTML = '';
            for (let i = 1; i <= NUM_TABLES; i++) {
                const btn = document.createElement('button');
                btn.textContent = `Mesa ${i}`;
                btn.style.padding = '8px 16px';
                btn.style.borderRadius = '8px';
                btn.style.border = i === currentTable ? '2px solid var(--primary-color)' : '1px solid #ccc';
                btn.style.background = i === currentTable ? 'var(--primary-color)' : '#fff';
                btn.style.color = i === currentTable ? '#fff' : '#333';
                btn.style.cursor = 'pointer';
                btn.onclick = function() {
                    currentTable = i;
                    clearActiveMainProduct(); // Clear active main product when switching tables
                    renderTabs();
                    renderCart();
                };
                tabDiv.appendChild(btn);
            }
            document.getElementById('current-table-num').textContent = currentTable;
        }

        function showAccompanimentsSection() {
            document.getElementById('acompanhamento-category-title').style.display = 'block';
            document.getElementById('acompanhamento-category').style.display = 'flex'; // Use flex for grid
            document.getElementById('confirm-accompaniments-btn').style.display = 'block';
        }

        function hideAccompanimentsSection() {
            document.getElementById('acompanhamento-category-title').style.display = 'none';
            document.getElementById('acompanhamento-category').style.display = 'none';
            document.getElementById('confirm-accompaniments-btn').style.display = 'none';
        }

        function highlightActiveMainProduct(id) {
            // Remove highlight from previous active product
            const prevActive = document.querySelector('.product-btn.active-main');
            if (prevActive) {
                prevActive.classList.remove('active-main');
            }
            // Add highlight to current active product
            // Find the button by its onclick attribute which contains the product ID
            const currentActiveBtn = document.querySelector(`.product-btn[onclick*="addToCart('${id}'"]`);
            if (currentActiveBtn) {
                currentActiveBtn.classList.add('active-main');
            }
        }

        function clearActiveMainProduct() {
            const prevActive = document.querySelector('.product-btn.active-main');
            if (prevActive) {
                prevActive.classList.remove('active-main');
            }
            activeMainProductId = null;
            hideAccompanimentsSection();
        }

        // --- CART LOGIC ---
        function addToCart(id, name, price, category) { // Pass category to addToCart
            let cart = carts[currentTable];

            // If an accompaniment is clicked while a main product is active
            if (activeMainProductId !== null && category === 'acompanhamento') {
                const mainProductInCart = cart[activeMainProductId];
                if (mainProductInCart) {
                    if (!mainProductInCart.accompaniments) {
                        mainProductInCart.accompaniments = {};
                    }
                    if (!mainProductInCart.accompaniments[id]) {
                        mainProductInCart.accompaniments[id] = { name: name, price: parseFloat(price), quantity: 1 };
                    } else {
                        mainProductInCart.accompaniments[id].quantity += 1;
                    }
                }
            }
            // If a main product (Tradicionais/Especiais) is clicked
            else if (category === 'tradicional' || category === 'especial') {
                // If there was an active main product, clear its active state
                if (activeMainProductId !== null) {
                    clearActiveMainProduct();
                }
                
                // Add the new main product
                if (!cart[id]) {
                    cart[id] = { name: name, price: parseFloat(price), quantity: 1, category: category, accompaniments: {} };
                } else {
                    cart[id].quantity += 1;
                }
                activeMainProductId = id;
                showAccompanimentsSection(); // Make accompaniments visible
                highlightActiveMainProduct(id); // Highlight the newly active main product
            }
            // If any other product is clicked (e.g., Bebida, Doce, or Acompanhamento without active main)
            else {
                // If an accompaniment was active, clear it
                if (activeMainProductId !== null) {
                    clearActiveMainProduct();
                }
                if (!cart[id]) {
                    cart[id] = { name: name, price: parseFloat(price), quantity: 1, category: category, accompaniments: {} };
                } else {
                    cart[id].quantity += 1;
                }
                hideAccompanimentsSection(); // Ensure accompaniments are hidden
            }
            renderCart();
        }

        function renderCart() {
            let cart = carts[currentTable];
            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = '';
            let subtotal = 0;

            for (const id in cart) {
                const item = cart[id];
                subtotal += item.price * item.quantity;
                cartList.innerHTML += `<li>${item.name} - R$ ${item.price.toFixed(2).replace('.', ',')} x ${item.quantity}</li>`;

                // Render accompaniments if they exist
                if (item.accompaniments && Object.keys(item.accompaniments).length > 0) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        subtotal += acc.price * acc.quantity;
                        cartList.innerHTML += `<li style="margin-left: 20px; font-size: 0.9em; color: #555;">+ ${acc.name} - R$ ${acc.price.toFixed(2).replace('.', ',')} x ${acc.quantity}</li>`;
                    }
                }
            }
            document.getElementById('subtotal').innerText = `Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('current-table-num').textContent = currentTable;
        }

        function formatForThermalPrinter(cart, orderNumber) {
            let txt = "******** La casa de Pastel ********\n";
            txt += `Pedido: ${orderNumber}\n`;
            txt += `Mesa: ${currentTable}\n`;
            txt += "-----------------------------------\n";
            let subtotal = 0;
            for (const id in cart) {
                const item = cart[id];
                txt += `${item.name.padEnd(20)} ${item.quantity} x R$${item.price.toFixed(2)}\n`;
                subtotal += item.price * item.quantity;

                if (item.accompaniments && Object.keys(item.accompaniments).length > 0) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        txt += `  + ${acc.name.padEnd(18)} ${acc.quantity} x R$${acc.price.toFixed(2)}\n`;
                        subtotal += acc.price * acc.quantity;
                    }
                }
            }
            txt += "-----------------------------------\n";
            txt += `TOTAL: R$${subtotal.toFixed(2)}\n`;
            txt += "******** Obrigado! ********\n";
            return txt;
        }

        function formatForKitchen(cart, orderNumber) {
            let txt = "***** La casa de Pastel - Cozinha *****\n";
            txt += `Pedido: ${orderNumber}\n`;
            txt += `Mesa: ${currentTable}\n`;
            txt += "-----------------------------------\n";
            for (const id in cart) {
                const item = cart[id];
                txt += `${item.name.padEnd(20)} x ${item.quantity}\n`;

                if (item.accompaniments && Object.keys(item.accompaniments).length > 0) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        txt += `  + ${acc.name.padEnd(18)} x ${acc.quantity}\n`;
                    }
                }
            }
            txt += "-----------------------------------\n";
            txt += "Preparar conforme pedido!\n";
            return txt;
        }

        function generateOrderNumber() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
            const timeStr = now.getHours().toString().padStart(2, '0') +
                            now.getMinutes().toString().padStart(2, '0') +
                            now.getSeconds().toString().padStart(2, '0');
            const seq = Math.floor(Math.random() * 9000) + 1000; // random 4-digit number
            return `${dateStr}${timeStr}-${seq}`;
        }

        async function saveOrderToDatabase(cart, tableNumber) {
            try {
                const response = await fetch('/save_order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // Send CSRF token
                    },
                    body: JSON.stringify({
                        table_number: tableNumber,
                        cart_items: cart
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('Order saved successfully:', data);
                    return data.order_id;
                } else {
                    console.error('Error saving order:', data.message);
                    alert('Erro ao salvar o pedido: ' + data.message);
                    return null;
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                alert('Erro de comunicação com o servidor ao salvar o pedido.');
                return null;
            }
        }

        document.getElementById('checkout-btn').onclick = async function() { // Make it async
            let cart = carts[currentTable];
            if (Object.keys(cart).length === 0) {
                alert("O carrinho está vazio!");
                return;
            }

            const orderId = await saveOrderToDatabase(cart, currentTable);
            if (orderId === null) {
                return; // Stop if saving failed
            }

            const orderNumber = generateOrderNumber(); // Use the generated order number for printing
            const txt = formatForThermalPrinter(cart, orderNumber)
                .replace(/\n/g, '<br>');

            const printWindow = window.open('', '', 'width=400,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Pedido ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${txt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();

            // Clear cart for the current table after successful checkout
            carts[currentTable] = {};
            renderCart();
            clearActiveMainProduct();
        };

        document.getElementById('kitchen-btn').onclick = async function() { // Make it async
            let cart = carts[currentTable];
            if (Object.keys(cart).length === 0) {
                alert("O carrinho está vazio!");
                return;
            }

            const orderId = await saveOrderToDatabase(cart, currentTable);
            if (orderId === null) {
                return; // Stop if saving failed
            }

            const orderNumber = generateOrderNumber(); // Use the generated order number for printing
            const txt = formatForKitchen(cart, orderNumber)
                .replace(/\n/g, '<br>');

            const printWindow = window.open('', '', 'width=400,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Cozinha ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${txt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();

            // Clear cart for the current table after successful checkout
            carts[currentTable] = {};
            renderCart();
            clearActiveMainProduct();
        };

        document.getElementById('confirm-accompaniments-btn').onclick = function() {
            clearActiveMainProduct();
            renderCart(); // Re-render to ensure display is correct
        };

        // Initial render
        renderTabs();
        renderCart();
    </script>
</body>
</html>