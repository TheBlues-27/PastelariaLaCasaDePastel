{% load static %}
{% load dict_extras %}
<!DOCTYPE html>
<html>
<head>
    <title>Sistema de PDV</title>
    <link rel="stylesheet" href="{% static 'pos/style.css' %}">
    <meta name="csrf-token" content="{% csrf_token %}">
</head>
<body>
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <h1 style="color:#ff9800; margin: 0;">La casa de Pastel</h1>
        <div>
            <a href="{% url 'dashboard' %}" class="header-btn">Dashboard</a>
            <a href="{% url 'logout' %}" class="header-btn">Sair</a>
        </div>
    </header>
    <div id="table-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; justify-content:center; margin-top: 20px;">
        <!-- Tabs will be generated by JS -->
    </div>
    <div style="text-align: center; margin-bottom: 20px;">
        <button id="view-history-btn" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Ver Histórico de Pedidos da Mesa</button>
    </div>
    <div class="container">
        <div class="products">
            <h2 style="color:#333;margin-bottom:16px;">Produtos</h2>
            {% for key, label in categories %}
                <h3 {% if key == 'acompanhamento' %}id="acompanhamento-category-title" style="display: none;"{% endif %}>{{ label }}</h3>
                <div class="product-grid" {% if key == 'acompanhamento' %}id="acompanhamento-category" style="display: none;"{% endif %}>
                    {% for product in products_by_category|get_item:key %}
                        <button class="product-btn" onclick="addToCart('{{ product.id }}', '{{ product.name }}', '{{ product.price }}', '{{ product.category }}')">
                            <span class="product-name">{{ product.name }}</span>
                            <span class="product-price">R$ {{ product.price }}</span>
                        </button>
                    {% empty %}
                        <span><em>Nenhum produto nesta categoria.</em></span>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        <div class="cart">
            <h2>Carrinho - Mesa <span id="current-table-num"></span></h2>
            <ul class="cart-list" id="cart-list"></ul>
            <div class="subtotal" id="subtotal">Subtotal: R$ 0,00</div>
            <button id="confirm-accompaniments-btn" style="width:100%;margin-top:8px; display: none;">Confirmar Acompanhamentos</button>
            <button id="print-all-btn" style="width:100%;margin-top:20px;">Imprimir Pedido Completo</button>
        </div>
    </div>

    <!-- Accompaniments Popup -->
    <div id="accompaniments-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-width: 600px; width: 90%;">
            <h3 style="color:#333;margin-bottom:16px;">Acompanhamentos</h3>
            <div class="product-grid">
                {% for product in products_by_category|get_item:'acompanhamento' %}
                    <button class="product-btn" onclick="addToCart('{{ product.id }}', '{{ product.name }}', '{{ product.price }}', '{{ product.category }}')">
                        <span class="product-name">{{ product.name }}</span>
                        <span class="product-price">R$ {{ product.price }}</span>
                    </button>
                {% empty %}
                    <span><em>Nenhum acompanhamento disponível.</em></span>
                {% endfor %}
            </div>
            <button id="close-accompaniments-popup-btn" style="width:100%;margin-top:20px; padding: 10px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Fechar Acompanhamentos</button>
        </div>
        
    </div>

    <!-- Order History Popup -->
    <div id="order-history-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
            <h3 style="color:#333;margin-bottom:16px;">Histórico de Pedidos - Mesa <span id="history-table-num"></span></h3>
            <div id="order-history-content">
                <!-- Order history will be loaded here -->
                <p>Carregando histórico...</p>
            </div>
            <button id="close-history-popup-btn" style="width:100%;margin-top:20px; padding: 10px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Fechar Histórico</button>
        </div>
    </div>

    <script>
        // --- TABLE TAB LOGIC ---
        const NUM_TABLES = 10; // Change this for more tables
        let currentTable = 1;
        let carts = {};
        for (let i = 1; i <= NUM_TABLES; i++) {
            carts[i] = {};
        }

        // Global state for accompaniment selection
        let activeMainProductId = null;

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        function renderTabs() {
            const tabDiv = document.getElementById('table-tabs');
            tabDiv.innerHTML = '';
            for (let i = 1; i <= NUM_TABLES; i++) {
                const btn = document.createElement('button');
                btn.textContent = `Mesa ${i}`;
                btn.style.padding = '8px 16px';
                btn.style.borderRadius = '8px';
                btn.style.border = i === currentTable ? '2px solid var(--primary-color)' : '1px solid #ccc';
                btn.style.background = i === currentTable ? 'var(--primary-color)' : '#fff';
                btn.style.color = i === currentTable ? '#fff' : '#333';
                btn.style.cursor = 'pointer';
                btn.onclick = function() {
                    currentTable = i;
                    clearActiveMainProduct(); // Clear active main product when switching tables
                    renderTabs();
                    renderCart();
                };
                tabDiv.appendChild(btn);
            }
            document.getElementById('current-table-num').textContent = currentTable;
        }

        function showAccompanimentsSection() {
            console.log('showAccompanimentsSection called: Displaying popup.'); // Debugging line
            document.getElementById('accompaniments-popup').style.display = 'flex'; // Show the popup
        }

        function hideAccompanimentsSection() {
            const popup = document.getElementById('accompaniments-popup');
            if (popup) {
                // Ensure display is set to 'none' with !important to override any conflicting styles
                popup.style.setProperty('display', 'none', 'important');
                console.log('hideAccompanimentsSection called: Popup display set to none !important.'); // Debugging line
            } else {
                console.error('Error: Accompaniments popup element not found when trying to hide.'); // Debugging line
            }
        }

        // --- Order History Popup Logic ---
        function showOrderHistoryPopup() {
            document.getElementById('history-table-num').textContent = currentTable;
            document.getElementById('order-history-popup').style.display = 'flex';
            fetchAndDisplayOrderHistory(currentTable);
        }

        function hideOrderHistoryPopup() {
            document.getElementById('order-history-popup').style.display = 'none';
        }

        async function fetchAndDisplayOrderHistory(tableNumber) {
            const historyContent = document.getElementById('order-history-content');
            historyContent.innerHTML = '<p>Carregando histórico...</p>'; // Show loading message

            try {
                // You will need to create a Django view and URL for '/get_order_history/<table_number>/'
                const response = await fetch(`/get_order_history/${tableNumber}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Order history fetched:', data);

                if (data.orders && data.orders.length > 0) {
                    let html = '';
                    data.orders.forEach(order => {
                        html += `<div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px;">`;
                        html += `<p><strong>Pedido ID:</strong> ${order.id}</p>`;
                        html += `<p><strong>Data:</strong> ${new Date(order.timestamp).toLocaleString()}</p>`;
                        html += `<p><strong>Total:</strong> R$ ${parseFloat(order.total_price).toFixed(2).replace('.', ',')}</p>`;
                        html += `<p><strong>Itens:</strong></p><ul>`;
                        order.items.forEach(item => {
                            html += `<li>${item.name} - R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')} x ${item.quantity}`;
                            if (item.accompaniments && item.accompaniments.length > 0) {
                                html += `<ul>`;
                                item.accompaniments.forEach(acc => {
                                    html += `<li style="font-size: 0.9em; color: #555;">+ ${acc.name} - R$ ${parseFloat(acc.price).toFixed(2).replace('.', ',')} x ${acc.quantity}</li>`;
                                });
                                html += `</ul>`;
                            }
                            html += `</li>`;
                        });
                        html += `</ul></div>`;
                    });
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<p>Nenhum pedido anterior encontrado para esta mesa.</p>';
                }

            } catch (error) {
                console.error('Error fetching order history:', error);
                historyContent.innerHTML = '<p>Erro ao carregar o histórico de pedidos.</p>';
            }
        }

        function highlightActiveMainProduct(id) {
            // Remove highlight from previous active product
            const prevActive = document.querySelector('.product-btn.active-main');
            if (prevActive) {
                prevActive.classList.remove('active-main');
            }
            // Add highlight to current active product
            // Find the button by its onclick attribute which contains the product ID
            const currentActiveBtn = document.querySelector(`.product-btn[onclick*="addToCart('${id}'"]`);
            if (currentActiveBtn) {
                currentActiveBtn.classList.add('active-main');
            }
        }

        function clearActiveMainProduct() {
            const prevActive = document.querySelector('.product-btn.active-main');
            if (prevActive) {
                prevActive.classList.remove('active-main');
            }
            activeMainProductId = null;
            hideAccompanimentsSection();
        }

        // --- CART LOGIC ---
        function addToCart(id, name, price, category) { // Pass category to addToCart
            let cart = carts[currentTable];

            // If an accompaniment is clicked while a main product is active
            if (activeMainProductId !== null && category === 'acompanhamento') {
                const mainProductInCart = cart[activeMainProductId];
                if (mainProductInCart) {
                    if (!mainProductInCart.accompaniments) {
                        mainProductInCart.accompaniments = {};
                    }
                    if (!mainProductInCart.accompaniments[id]) {
                        mainProductInCart.accompaniments[id] = { name: name, price: parseFloat(price), quantity: 1 };
                    } else {
                        mainProductInCart.accompaniments[id].quantity += 1;
                    }
                }
            }
            // If a main product (Tradicionais/Especiais) is clicked
            else if (category === 'tradicional' || category === 'especial') {
                // If there was an active main product, clear its active state
                if (activeMainProductId !== null) {
                    clearActiveMainProduct();
                }
                
                // Add the new main product
                if (!cart[id]) {
                    cart[id] = { name: name, price: parseFloat(price), quantity: 1, category: category, accompaniments: {} };
                } else {
                    cart[id].quantity += 1;
                }
                activeMainProductId = id;
                showAccompanimentsSection(); // Make accompaniments visible
                highlightActiveMainProduct(id); // Highlight the newly active main product
            }
            // If any other product is clicked (e.g., Bebida, Doce, or Acompanhamento without active main)
            else {
                // If an accompaniment was active, clear it
                if (activeMainProductId !== null) {
                    clearActiveMainProduct();
                }
                if (!cart[id]) {
                    cart[id] = { name: name, price: parseFloat(price), quantity: 1, category: category, accompaniments: {} };
                } else {
                    cart[id].quantity += 1;
                }
                hideAccompanimentsSection(); // Ensure accompaniments are hidden
            }
            renderCart();
        }

        function renderCart() {
            let cart = carts[currentTable];
            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = '';
            let subtotal = 0;

            for (const id in cart) {
                const item = cart[id];
                subtotal += item.price * item.quantity;
                cartList.innerHTML += `<li>${item.name} - R$ ${item.price.toFixed(2).replace('.', ',')} x ${item.quantity}</li>`;

                // Render accompaniments if they exist
                if (item.accompaniments && Object.keys(item.accompaniments).length > 0) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        subtotal += acc.price * acc.quantity;
                        cartList.innerHTML += `<li style="margin-left: 20px; font-size: 0.9em; color: #555;">+ ${acc.name} - R$ ${acc.price.toFixed(2).replace('.', ',')} x ${acc.quantity}</li>`;
                    }
                }
            }
            document.getElementById('subtotal').innerText = `Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('current-table-num').textContent = currentTable;
        }

        function formatForThermalPrinter(cart, orderNumber) {
            let txt = "******** La casa de Pastel ********\n";
            txt += `Pedido: ${orderNumber}\n`;
            txt += `Mesa: ${currentTable}\n`;
            txt += "-----------------------------------\n";
            let subtotal = 0;
            for (const id in cart) {
                const item = cart[id];
                txt += `${item.name.padEnd(20)} ${item.quantity} x R$${item.price.toFixed(2)}\n`;
                subtotal += item.price * item.quantity;

                if (item.accompaniments && Object.keys(item.accompaniments).length > 0) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        txt += `  + ${acc.name.padEnd(18)} ${acc.quantity} x R$${acc.price.toFixed(2)}\n`;
                        subtotal += acc.price * acc.quantity;
                    }
                }
            }
            txt += "-----------------------------------\n";
            txt += `TOTAL: R$${subtotal.toFixed(2)}\n`;
            txt += "******** Obrigado! ********\n";
            return txt;
        }

        function formatForKitchen(cart, orderNumber) {
            let txt = "***** La casa de Pastel - Cozinha *****\n";
            txt += `Pedido: ${orderNumber}\n`;
            txt += `Mesa: ${currentTable}\n`;
            txt += "-----------------------------------\n";
            for (const id in cart) {
                const item = cart[id];
                txt += `${item.name.padEnd(20)} x ${item.quantity}\n`;

                if (item.accompaniments && Object.keys(item.accompaniments).length > 0) {
                    for (const accId in item.accompaniments) {
                        const acc = item.accompaniments[accId];
                        txt += `  + ${acc.name.padEnd(18)} x ${acc.quantity}\n`;
                    }
                }
            }
            txt += "-----------------------------------\n";
            txt += "Preparar conforme pedido!\n";
            return txt;
        }

        function generateOrderNumber() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
            const timeStr = now.getHours().toString().padStart(2, '0') +
                            now.getMinutes().toString().padStart(2, '0') +
                            now.getSeconds().toString().padStart(2, '0');
            const seq = Math.floor(Math.random() * 9000) + 1000; // random 4-digit number
            return `${dateStr}${timeStr}-${seq}`;
        }

        async function saveOrderToDatabase(cart, tableNumber) {
            try {
                const response = await fetch('/save_order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // Send CSRF token
                    },
                    body: JSON.stringify({
                        table_number: tableNumber,
                        cart_items: cart
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('Order saved successfully:', data);
                    return data.order_id;
                } else {
                    console.error('Error saving order:', data.message);
                    alert('Erro ao salvar o pedido: ' + data.message);
                    return null;
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                alert('Erro de comunicação com o servidor ao salvar o pedido.');
                return null;
            }
        }

        document.getElementById('print-all-btn').onclick = async function() {
            let cart = carts[currentTable];
            if (Object.keys(cart).length === 0) {
                alert("O carrinho está vazio!");
                return;
            }

            const orderId = await saveOrderToDatabase(cart, currentTable);
            if (orderId === null) {
                return; // Stop if saving failed
            }

            const orderNumber = generateOrderNumber();

            // Print Client Ticket
            const clientTxt = formatForThermalPrinter(cart, orderNumber).replace(/\n/g, '<br>');
            const clientPrintWindow = window.open('', '_blank', 'width=400,height=600');
            clientPrintWindow.document.write(`
                <html>
                <head>
                    <title>Pedido Cliente ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${clientTxt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            clientPrintWindow.document.close();
            clientPrintWindow.focus();

            // Print Kitchen Ticket
            const kitchenTxt = formatForKitchen(cart, orderNumber).replace(/\n/g, '<br>');
            const kitchenPrintWindow = window.open('', '_blank', 'width=400,height=600');
            kitchenPrintWindow.document.write(`
                <html>
                <head>
                    <title>Pedido Cozinha ${orderNumber}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        .receipt { white-space: pre-wrap; font-size: 1.1em; }
                    </style>
                </head>
                <body>
                    <div class="receipt">${kitchenTxt}</div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            kitchenPrintWindow.document.close();
            kitchenPrintWindow.focus();

            // Clear cart for the current table after successful printing
            carts[currentTable] = {};
            renderCart();
            clearActiveMainProduct();
        };

        document.getElementById('confirm-accompaniments-btn').onclick = function() {
            clearActiveMainProduct();
            renderCart(); // Re-render to ensure display is correct
        };

        document.getElementById('close-accompaniments-popup-btn').onclick = function() {
            console.log('Close accompaniments popup button clicked.'); // Debugging line
            // This function already calls hideAccompanimentsSection() internally
            clearActiveMainProduct(); 
            renderCart(); // Re-render to ensure display is correct
        };

        document.getElementById('view-history-btn').onclick = function() {
            showOrderHistoryPopup();
        };

        document.getElementById('close-history-popup-btn').onclick = function() {
            hideOrderHistoryPopup();
        };

        // Initial render
        renderTabs();
        renderCart();
    </script>
</body>
</html>